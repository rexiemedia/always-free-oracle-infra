- name: Ensure WireGuard config directory exists
  file:
    path: /etc/wireguard
    state: directory
    mode: '0700'

- name: Deploy WireGuard config file
  template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    mode: '0600'

- name: Check if community.docker collection is available
  command: ansible-galaxy collection list community.docker
  register: docker_collection_check
  ignore_errors: true
  delegate_to: localhost
  changed_when: false
  run_once: true

- name: Set fact if docker_collection_available
  set_fact:
    docker_collection_available: "{{ 'community.docker' in docker_collection_check.stdout }}"

- name: Check if port 51820/udp is in use
  ansible.builtin.command: ss -lunp
  register: port_check
  changed_when: false

- name: Fail if port 51820 is already in use
  ansible.builtin.fail:
    msg: "Port 51820/udp is already in use on {{ inventory_hostname }}. Stop native WireGuard (wg0) or free the port."
  when: port_check.stdout is search("(:51820\\s)")

- name: Remove stale WireGuard container if stuck
  community.docker.docker_container:
    name: wireguard
    state: absent
  ignore_errors: true
  when: docker_collection_available

- name: Deploy WireGuard container with community.docker
  community.docker.docker_container:
    name: wireguard
    image: linuxserver/wireguard:latest
    state: started
    restart_policy: always
    recreate: true
    privileged: true
    volumes:
      - /etc/wireguard:/config
      - /lib/modules:/lib/modules
    ports:
      - "51820:51820/udp"
    capabilities:
      - NET_ADMIN
  when: docker_collection_available

- name: Deploy WireGuard container with raw docker run (fallback)
  command: >
    docker run -d
    --name wireguard
    --restart always
    --privileged
    -v /etc/wireguard:/config
    -v /lib/modules:/lib/modules
    -p 51820:51820/udp
    --cap-add=NET_ADMIN
    linuxserver/wireguard:latest
  args:
    creates: /var/lib/docker/containers
  when: not docker_collection_available
