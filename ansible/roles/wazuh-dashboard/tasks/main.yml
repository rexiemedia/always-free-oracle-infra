---
- name: Create Wazuh network
  community.docker.docker_network:
    name: wazuh-net

- name: Ensure Wazuh Dashboard container is running
  community.docker.docker_container:
    name: wazuh-dashboard
    image: wazuh/wazuh-dashboard:4.7.3
    platform: linux/amd64
    state: started
    restart_policy: always
    networks:
      - name: wazuh-net
    ports:
      - "5601:5601"
    env:
      WAZUH_API_URL: "https://wazuh-manager:55000"
      WAZUH_API_USER: "{{ wazuh_api_user }}"
      WAZUH_API_PASSWORD: "{{ wazuh_api_password }}"
      WAZUH_INDEXER_URL: "https://{{ wazuh_indexer_host }}:9200"

#Firewall rules
- name: Allow 5601/tcp only from Nginx
  firewalld:
    rich_rule: 'rule family="ipv4" source address="{{ nginx_private_ip }}" port protocol="tcp" port="5601" accept'
    permanent: yes
    state: enabled

- name: Reload firewalld
  command: firewall-cmd --reload
